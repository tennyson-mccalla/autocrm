#!/bin/sh

set -x  # Enable debug mode to print commands as they are executed

# Function to check for potential secrets using TruffleHog
check_trufflehog() {
    echo "üîç Running TruffleHog scan..."
    if command -v trufflehog > /dev/null 2>&1; then
        if trufflehog git file://. --since-commit HEAD --only-verified --fail; then
            echo "‚úÖ TruffleHog scan passed"
            return 0
        else
            echo "‚ùå TruffleHog found potential secrets in your changes"
            echo "Please remove any sensitive information before pushing"
            return 1
        fi
    else
        echo "‚ö†Ô∏è  Warning: TruffleHog not found. Install with: pip install trufflehog"
        return 0
    fi
}

# Function to check for potential secrets
check_secrets() {
    echo "üîç Checking for potential secrets and sensitive data..."

    # Simpler patterns that are more shell-compatible
    PATTERNS=(
        "api_key="
        "api_secret="
        "password="
        "secret_key="
        "private_key="
        "aws_access_key="
        "aws_secret="
        "gh_token="
        "firebase="
        "stripe="
        "mongodb+srv="
    )

    # Files to exclude from check
    EXCLUDES="package-lock.json\|yarn.lock\|.husky/\|.git/\|.test.ts\|.test.js\|.example"

    for pattern in "${PATTERNS[@]}"; do
        echo "Checking pattern: $pattern"
        FOUND=$(git diff --cached --name-only | grep -v -E "$EXCLUDES" | xargs grep -l "$pattern" 2>/dev/null)
        if [ -n "$FOUND" ]; then
            echo "‚ùå Potential secret or sensitive data found in:"
            echo "$FOUND"
            echo "Pattern matched: $pattern"
            echo "Please remove secrets and use environment variables instead."
            return 1
        fi
    done
    echo "‚úÖ No secrets found"
    return 0
}

# Function to check for unencrypted .env files
check_env_files() {
    echo "üîç Checking for unencrypted .env files..."

    # Look for .env files that aren't .env.example in the current commit
    ENV_FILES=$(git diff --cached --name-only | grep "\.env" | grep -v "\.env\.example$")
    if [ -n "$ENV_FILES" ]; then
        echo "‚ùå New .env file detected in commit:"
        echo "$ENV_FILES"
        echo "Please remove .env files and add them to .gitignore"
        return 1
    fi
    echo "‚úÖ No .env files found"
    return 0
}

# Function to run build check
run_build_check() {
    echo "üèóÔ∏è Running build check before push..."

    # Store current directory
    CURRENT_DIR=$(pwd)
    echo "Current directory: $CURRENT_DIR"

    # Check if frontend directory exists and contains package.json
    if [ -d "frontend" ] && [ -f "frontend/package.json" ]; then
        cd frontend || return 1
        echo "Changed to frontend directory: $(pwd)"
        if NODE_OPTIONS='--no-deprecation' npm run build; then
            echo "‚úÖ Build successful!"
            cd "$CURRENT_DIR" || return 1
            return 0
        else
            echo "‚ùå Build failed"
            cd "$CURRENT_DIR" || return 1
            return 1
        fi
    else
        echo "‚ö†Ô∏è No frontend build needed"
        return 0
    fi
}

# Run all security checks
echo "üîí Running security checks before push..."
check_trufflehog || { echo "TruffleHog check failed"; exit 1; }
check_secrets || { echo "Secrets check failed"; exit 1; }
check_env_files || { echo "Env files check failed"; exit 1; }

# Run build check
run_build_check || { echo "Build check failed"; exit 1; }

echo "‚úÖ All checks passed! Proceeding with push..."
